<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MongoDB-复制集, PA &amp; CODING">
    <meta name="description" content="
复制集架构
复制集操作
复制集成员角色
复制集高可用
复制集数据同步机制 oplog


复制集架构

在生产环境中，不建议使用单机版的MongoDB服务器

单机版的MongoDB无法保证可靠性，一旦进程发生故障或是服务器宕机，业务将直">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>MongoDB-复制集 | PA &amp; CODING</title>
    <link rel="icon" type="image/png" href="/favicon-kali.png">
    
    <style>
        body{
            background-image: url(/background.jpg);
            background-repeat:no-repeat;
            background-size: 100% 100%;
            background-attachment:fixed;
        }
    </style>



    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="PA & CODING" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/favicon-kali.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">PA &amp; CODING</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/favicon-kali.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">PA &amp; CODING</div>
        <div class="logo-desc">
            
            行到水穷处，坐看云起时
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/jxch" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/jxch" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/30.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MongoDB-复制集</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MongoDB/">
                                <span class="chip bg-color">MongoDB</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/IT%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                IT学习笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-09-06
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    20 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <ul>
<li>复制集架构</li>
<li>复制集操作</li>
<li>复制集成员角色</li>
<li>复制集高可用</li>
<li>复制集数据同步机制 oplog</li>
</ul>
<hr>
<h2 id="复制集架构">复制集架构</h2>
<ul>
<li>在生产环境中，不建议使用单机版的MongoDB服务器
<ul>
<li>单机版的MongoDB无法保证可靠性，一旦进程发生故障或是服务器宕机，业务将直接不可用</li>
<li>一旦服务器上的磁盘损坏，数据会直接丢失，而此时并没有任何副本可用</li>
</ul>
</li>
<li>Mongodb复制集（Replication&nbsp;Set）由一组Mongod实例（进程）组成，包含一个Primary节点和多个Secondary节点
<ul>
<li>Mongodb&nbsp;Driver（客户端）的所有数据都写入Primary</li>
<li>Secondary从Primary同步写入的数据，以保持复制集内所有成员存储相同的数据集，提供数据的高可用</li>
<li><img src="/static/IT/MongoDB/MongoDB-%E5%A4%8D%E5%88%B6%E9%9B%86-1.png" alt="Mongodb复制集"></li>
</ul>
</li>
<li>复制集提供冗余和高可用性，是所有生产部署的基础，依赖于两个方面的功能
<ul>
<li>数据写入时将数据迅速复制到另一个独立节点上</li>
<li>在接受写入的节点发生故障时自动选举出一个新的替代节点</li>
</ul>
</li>
<li>在实现高可用的同时，复制集实现了其他几个附加作用
<ul>
<li>数据分发：将数据从一个区域复制到另一个区域，减少另一个区域的读延迟</li>
<li>读写分离：不同类型的压力分别在不同的节点上执行</li>
<li>异地容灾：在数据中心故障时候快速切换到异地</li>
</ul>
</li>
<li>local.system.replset：用来记录当前复制集的成员</li>
<li>local.startup_log：用来记录本地数据库的启动日志信息</li>
<li>local.replset.minvalid：用来记录复制集的跟踪信息，如初始化同步需要的字段</li>
</ul>
<hr>
<h2 id="复制集操作">复制集操作</h2>
<ul>
<li>PSS模式（官方推荐模式）：由一个主节点和两个备节点所组成，即 Primary+Secondary+Secondary
<ul>
<li><img src="/static/IT/MongoDB/MongoDB-%E5%A4%8D%E5%88%B6%E9%9B%86-2.png" alt="PSS模式"></li>
<li>此模式始终提供数据集的两个完整副本，如果主节点不可用，则复制集选择备节点作为主节点并继续正常操作。旧的主节点在可用时重新加入复制集</li>
</ul>
</li>
<li>PSA模式：由一个主节点、一个备节点和一个仲裁者节点组成，即 Primary+Secondary+Arbiter
<ul>
<li><img src="/static/IT/MongoDB/MongoDB-%E5%A4%8D%E5%88%B6%E9%9B%86-3.png" alt="PSA模式"></li>
<li>其中，Arbiter节点不存储数据副本，也不提供业务的读写操作</li>
<li>Arbiter节点发生故障不影响业务，仅影响选举投票</li>
<li>此模式仅提供数据的一个完整副本，如果主节点不可用，则复制集将选择备节点作为主节点</li>
</ul>
</li>
<li>复制集环境搭建
<ul>
<li>即使暂时只有一台服务器，也要以单节点模式启动复制集
<ul>
<li>单机多实例启动复制集</li>
<li>单节点启动复制集</li>
</ul>
</li>
<li>复制集各节点软件版本必须一致</li>
<li>增加节点不会增加系统写性能</li>
<li>启动&nbsp;MongoDB&nbsp;进程：<code>mongod&nbsp;‐f&nbsp;/data/db1/mongod.conf</code></li>
<li>配置复制集
<ul>
<li>复制集通过<code>replSetInitiate</code>命令或mongo&nbsp;shell的<code>rs.initiate()</code>进行初始化
<ul>
<li><code>rs.initiate()</code></li>
<li><code>rs.add("192.168.65.174:28018")</code></li>
<li>或 <code>rs.initiate({_id:&nbsp;"rs0",members:&nbsp;[{_id:&nbsp;0,host:&nbsp;"192.168.65.174:28017"}]})</code></li>
</ul>
</li>
<li>初始化后各个成员间开始发送心跳消息，并发起Priamry选举操作</li>
<li>获得『大多数』成员投票支持的节点，会成为Primary，其余节点成为Secondary</li>
</ul>
</li>
</ul>
</li>
<li>复制集状态查询
<ul>
<li><code>rs.status()</code> 查看复制集整体状态
<ul>
<li>可查看各成员当前状态，包括是否健康，是否在全量同步，心跳信息，增量同步信息，&nbsp;选举信息，上一次的心跳时间等</li>
</ul>
</li>
<li><code>db.isMaster()</code> 查看当前节点角色
<ul>
<li>除了当前节点角色信息，是一个更精简化的信息，也返回整个复制集的成员列表，真正的Primary是谁，协议相关的配置信息等，Driver&nbsp;在首次连接复制集时会发送该命令</li>
</ul>
</li>
</ul>
</li>
<li>Mongo&nbsp;Shell 复制集命令
<ul>
<li>rs.add()&nbsp;为复制集新增节点</li>
<li>rs.addArb()&nbsp;为复制集新增一个&nbsp;arbiter</li>
<li>rs.conf()&nbsp;返回复制集配置信息</li>
<li>rs.freeze()&nbsp;防止当前节点在一段时间内选举成为主节点</li>
<li>rs.help()&nbsp;返回&nbsp;replica&nbsp;set&nbsp;的命令帮助</li>
<li>rs.initiate()&nbsp;初始化一个新的复制集</li>
<li>rs.printReplicationInfo()&nbsp;以主节点的视角返回复制的状态报告</li>
<li>rs.printSecondaryReplicationInfo() 以从节点的视角返回复制状态报告</li>
<li>rs.reconfig() 通过重新应用复制集配置来为复制集更新配置</li>
<li>rs.remove()&nbsp;从复制集中移除一个节点</li>
<li>rs.secondaryOk()&nbsp;为当前的连接设置从节点可读
<ul>
<li>在默认配置下，MongoDB 的客户端会将读操作只定向到主节点，这样可以确保读取的数据是最新的，因为主节点是接受写操作的唯一节点</li>
</ul>
</li>
<li>rs.status()&nbsp;返回复制集状态信息</li>
<li>rs.stepDown()&nbsp;让当前的&nbsp;primary&nbsp;变为从节点并触发&nbsp;election</li>
<li>rs.syncFrom()&nbsp;设置复制集节点从哪个节点处同步数据，将会覆盖默认选取逻辑</li>
</ul>
</li>
<li>安全认证
<ul>
<li>创建用户
<ul>
<li><code>use&nbsp;admin</code></li>
<li><code>db.createUser({user:"fox",pwd:"fox",roles:[{role:"clusterAdmin",db:"admin"}]})</code></li>
</ul>
</li>
<li>创建keyFile文件：&nbsp;集群之间的安全认证（开启keyfile认证就默认开启了auth认证了）
<ul>
<li><code>openssl&nbsp;rand&nbsp;‐base64&nbsp;756&nbsp;&gt;&nbsp;/data/mongo.key</code></li>
<li>创建keyFile前，需要先停掉复制集中所有主从节点的mongod服务，然后再创建，否则有可能出现服务启动不了的情况</li>
<li>将主节点中的keyfile文件拷贝到复制集其他从节点服务器中，路径地址对应mongo.conf配置文件中的keyFile字段地址，并设置keyfile权限为600</li>
<li>启动命令 <code>mongod&nbsp;‐f&nbsp;/data/db1/mongod.conf&nbsp;‐‐keyFile&nbsp;/data/mongo.key</code></li>
<li>客户端连接 <code>mongo&nbsp;‐‐port&nbsp;28017&nbsp;‐ufox&nbsp;‐pfox&nbsp;‐‐authenticationDatabase=admin</code></li>
</ul>
</li>
</ul>
</li>
<li>复制集连接方式
<ul>
<li>方式一：直接连接&nbsp;Primary&nbsp;节点，正常情况下可读写&nbsp;MongoDB，但主节点故障切换后，无法正常访问</li>
<li>方式二（强烈推荐）：通过高可用&nbsp;Uri&nbsp;的方式连接&nbsp;MongoDB，当&nbsp;Primary&nbsp;故障切换后，MongoDB&nbsp;Driver&nbsp;可自动感知并把流量路由到新的&nbsp;Primary&nbsp;节点
<ul>
<li>springboot 可以同时配置集群内所有节点</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="复制集成员角色">复制集成员角色</h2>
<ul>
<li>属性一：Priority&nbsp;=&nbsp;0
<ul>
<li>当&nbsp;Priority&nbsp;等于&nbsp;0&nbsp;时，它不可以被复制集选举为主</li>
<li>Priority&nbsp;的值越高，则被选举为主的概率更大</li>
<li>通常，在跨机房方式下部署复制集可以使用该特性</li>
</ul>
</li>
<li>属性二：Vote&nbsp;=&nbsp;0
<ul>
<li>不可以参与选举投票，此时该节点的&nbsp;Priority&nbsp;也必须为&nbsp;0，即它也不能被选举为主</li>
<li>由于一个复制集中最多只有7个投票成员，因此多出来的成员则必须将其vote属性值设置为0</li>
</ul>
</li>
<li>成员角色
<ul>
<li>Primary：主节点，其接收所有的写请求，然后把修改同步到所有备节点
<ul>
<li>一个复制集只能有一个主节点，当主节点“挂掉”后，其他节点会重新选举出来一个主节点</li>
</ul>
</li>
<li>Secondary：备节点，与主节点保持同样的数据集；当主节点“挂掉”时，参与竞选主节点
<ul>
<li>分为以下三个不同类型
<ul>
<li>Hidden&nbsp;=&nbsp;false：正常的只读节点，是否可选为主，是否可投票，取决于&nbsp;Priority，Vote&nbsp;的值</li>
<li>Hidden&nbsp;=&nbsp;true：隐藏节点，对客户端不可见，&nbsp;可以参与选举，但是&nbsp;Priority&nbsp;必须为&nbsp;0，即不能被提升为主
<ul>
<li>由于隐藏节点不会接受业务访问，因此可通过隐藏节点做一些数据备份、离线计算的任务，这并不会影响整个复制集</li>
<li>在其他节点上执行&nbsp;db.isMaster()&nbsp;将不会显示隐藏节点</li>
</ul>
</li>
<li>Delayed&nbsp;：延迟节点，必须同时具备隐藏节点和Priority0的特性
<ul>
<li>会延迟一定的时间（SlaveDelay&nbsp;配置决定）从上游复制增量</li>
<li>常用于快速回滚场景</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Arbiter：仲裁节点，只用于参与选举投票，本身不承载任何数据，只作为投票角色
<ul>
<li>2个节点的复制集，1个&nbsp;Primary，1个Secondary，任意节点宕机，复制集将不能提供服务了（无法选出Primary），这时可以给复制集添加㇐个&nbsp;Arbiter节点，即使有节点宕机，仍能选出Primary</li>
<li>当复制集成员为偶数时，最好加入㇐个Arbiter节点，以提升复制集可用性</li>
</ul>
</li>
</ul>
</li>
<li>配置隐藏节点：很多情况下将节点设置为隐藏节点是用来协助&nbsp;delayed&nbsp;members&nbsp;的
<ul>
<li><code>cfg&nbsp;=&nbsp;rs.conf()</code></li>
<li><code>cfg.members[1].priority&nbsp;=&nbsp;0</code></li>
<li><code>cfg.members[1].hidden&nbsp;=&nbsp;true</code></li>
<li><code>rs.reconfig(cfg)</code></li>
</ul>
</li>
<li>配置延时节点：当我们配置一个延时节点的时候，复制过程与该节点的&nbsp;oplog&nbsp;都将延时时。延时节点中的数据集将会比复制集中主节点的数据延后
<ul>
<li><code>cfg&nbsp;=&nbsp;rs.conf()</code></li>
<li><code>cfg.members[1].priority&nbsp;=&nbsp;0</code></li>
<li><code>cfg.members[1].hidden&nbsp;=&nbsp;true</code></li>
<li><code>cfg.members[1].slaveDelay&nbsp;=&nbsp;60</code> 延迟1分钟</li>
<li><code>rs.reconfig(cfg)</code></li>
</ul>
</li>
<li>查看复制延迟：如果希望查看当前节点oplog的情况，则可以使用<code>rs.printReplicationInfo()</code>命令
<ul>
<li>oplog的大小、最早一条oplog以及最后一条oplog的产生时间</li>
<li>通常在oplog大小不变的情况下，业务写操作越频繁，复制窗口（时间差）就会越短</li>
<li>在节点上执行<code>rs.printSecondaryReplicationInfo()</code>命令，可以一并列出所有备节点成员的同步延迟情况</li>
</ul>
</li>
<li>添加投票节点
<ul>
<li><code>mongod&nbsp;‐‐port&nbsp;30000&nbsp;‐‐dbpath&nbsp;/data/arb&nbsp;‐‐replSet&nbsp;rs0</code> 启动仲裁节点，指定数据目录和复制集名称</li>
<li><code>rs.addArb("ip:30000")</code> 添加仲裁节点到复制集</li>
</ul>
</li>
<li>移除复制集节点
<ul>
<li>使用&nbsp;<code>rs.remove()</code>&nbsp;来移除节点 <code>rs.remove("ip:port")</code></li>
<li>通过&nbsp;<code>rs.reconfig()</code>&nbsp;来移除节点
<ul>
<li><code>cfg&nbsp;=&nbsp;rs.conf()</code></li>
<li><code>cfg.members.splice(2,1)</code> 从2开始移除1个元素</li>
<li><code>rs.reconfig(cfg)</code></li>
</ul>
</li>
</ul>
</li>
<li>更改复制集节点
<ul>
<li><code>cfg&nbsp;=&nbsp;rs.conf()</code></li>
<li><code>cfg.members[0].host&nbsp;=&nbsp;"ip:port"</code></li>
<li><code>rs.reconfig(cfg)</code></li>
</ul>
</li>
</ul>
<hr>
<h2 id="复制集高可用">复制集高可用</h2>
<ul>
<li>复制集选举：Raft算法实现，选举成功的必要条件是大多数投票节点存活
<ul>
<li>MongoDB对raft协议添加了一些扩展
<ul>
<li>支持chainingAllowed链式复制
<ul>
<li>从节点不只是从主节点上同步数据，还可以选择一个离自己最近（心跳延时最小）的节点来复制数据</li>
</ul>
</li>
<li>增加了预投票阶段，即 preVote
<ul>
<li>主要是用来避免网络分区时产生 Term (任期) 值激增的问题
<ul>
<li>多个节点同时选举；选举失败重试</li>
</ul>
</li>
<li>当一个节点认为自己有资格成为主节点时，它首先会向副本集中的其他节点发送预投票请求
<ul>
<li>接收到预投票请求的节点会根据自身的状态进行检查，决定是否同意该请求</li>
<li>如果接收预投票请求的节点同意该请求，它就会给发起节点一个正面的响应</li>
<li>如果发起请求的节点收到足够多的正面响应（大多数节点同意它参与正式选举），它才会正式发起选举。否则，该节点会放弃这次尝试，并等待一段时间后再重试</li>
</ul>
</li>
</ul>
</li>
<li>支持投票优先级
<ul>
<li>如果从节点发现自己的优先级比主节点高，则会主动发起投票并尝试成为新的主节点</li>
</ul>
</li>
<li>一个复制集最多可以有50&nbsp;个成员，但只有&nbsp;7&nbsp;个投票成员
<ul>
<li>因为一旦过多的成员参与数据复制、投票过程，将会带来更多可靠性方面的问题</li>
</ul>
</li>
</ul>
</li>
<li>当复制集内存活的成员数量不足大多数时，整个复制集将无法选举出主节点，此时无法提供写服务，这些节点都将处于只读状态</li>
<li>如果希望避免平票结果的产生，最好使用奇数个节点成员，比如3个或5个。当然，在MongoDB复制集的实现中，对于平票问题已经提供了解决方案
<ul>
<li>为选举定时器增加少量的随机时间偏差，这样避免各个节点在同一时刻发起选举，提高成功率</li>
<li>使用仲裁者角色，该角色不做数据复制，也不承担读写业务，仅仅用来投票</li>
</ul>
</li>
</ul>
</li>
<li>自动故障转移
<ul>
<li>在复制集组建完成之后，各成员节点会开启定时器，持续向其他成员发起心跳；这里涉及的参数为 heartbeatIntervalMillis，即心跳间隔时间，默认值是2s
<ul>
<li>如果心跳成功，则会持续以2s的频率继续发送心跳</li>
<li>如果心跳失败，则会立即重试心跳，一直到心跳恢复成功</li>
</ul>
</li>
<li>选举超时检测，一次心跳检测失败并不会立即触发重新选举；除了心跳，成员节点还会启动一个选举超时检测定时器，该定时器默认以10s的间隔执行，具体可以通过electionTimeoutMillis参数指定
<ul>
<li>如果心跳响应成功，则取消上一次的electionTimeout调度（保证不会发起选举），并发起新一轮electionTimeout调度</li>
<li>如果心跳响应迟迟不能成功，那么electionTimeout任务被触发，进而导致备节点发起选举并成为新的主节点</li>
</ul>
</li>
<li>在MongoDB的实现中，选举超时检测的周期要略大于electionTimeoutMillis设定
<ul>
<li>该周期会加入一个随机偏移量，大约在10～11.5s，如此的设计是为了错开多个备节点主动选举的时间，提升成功率</li>
</ul>
</li>
<li>在electionTimeout任务中触发选举必须要满足以下条件
<ul>
<li>当前节点是备节点；当前节点具备选举权限；在检测周期内仍然没有与主节点心跳成功</li>
</ul>
</li>
</ul>
</li>
<li>业务影响评估
<ul>
<li>在复制集发生主备节点切换的情况下，会出现短暂的无主节点阶段，此时无法接受业务写操作
<ul>
<li>如果是因为主节点故障导致的切换，则对于该节点的所有读写操作都会产生超时
<ul>
<li>可以通过开启retryWrite来降低影响
<ul>
<li><code>mongodb://localhost/?retryWrites=true</code></li>
<li><code>mongo&nbsp;‐‐retryWrites</code></li>
</ul>
</li>
</ul>
</li>
<li>如果主节点属于强制掉电，那么整个Failover过程将会变长，很可能需要在Election定时器超时后才被其他节点感知并恢复，这个时间窗口一般会在12s以内；实际上，对于业务呼损的考量还应该加上客户端或mongos对于复制集角色的监视和感知行为（真实的情况可能需要长达30s以上）
<ul>
<li>对于非常重要的业务，建议在业务层面做一些防护策略，比如设计重试机制</li>
</ul>
</li>
</ul>
</li>
<li>如果想不丢数据重启复制集，更优雅的打开方式应该是这样的
<ul>
<li>逐个重启复制集里所有的Secondary节点</li>
<li>对Primary发送rs.stepDown()命令，等待primary降级为Secondary</li>
<li>重启降级后的Primary</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="复制集数据同步机制-oplog">复制集数据同步机制 oplog</h2>
<ul>
<li>在复制集架构中，主节点与备节点之间是通过oplog来同步数据的
<ul>
<li><img src="/static/IT/MongoDB/MongoDB-%E5%A4%8D%E5%88%B6%E9%9B%86-4.png" alt="oplog">
<ul>
<li>这里的oplog是一个特殊的固定集合</li>
<li>当主节点上的一个写操作完成后，会向oplog集合写入一条对应的日志</li>
<li>备节点则通过这个oplog不断拉取到新的日志，在本地进行回放以达到数据同步的目的</li>
</ul>
</li>
</ul>
</li>
<li>MongoDB&nbsp;oplog
<ul>
<li>MongoDB&nbsp;oplog&nbsp;是&nbsp;Local&nbsp;库下的一个集合，用来保存写操作所产生的增量日志</li>
<li>它是一个&nbsp;Capped&nbsp;Collection（固定集合），即超出配置的最大值后，会自动删除最老的历史数据
<ul>
<li>MongoDB&nbsp;针对&nbsp;oplog&nbsp;的删除有特殊优化，以提升删除效率</li>
</ul>
</li>
<li>主节点产生新的&nbsp;oplog&nbsp;Entry，从节点通过复制&nbsp;oplog&nbsp;并应用来保持和主节点的状态一致</li>
</ul>
</li>
<li>查看 oplog
<ul>
<li><code>use&nbsp;local</code></li>
<li><code>db.oplog.rs.find().sort({$natural:‐1}).pretty()</code>
<ul>
<li>ts字段描述了oplog产生的时间戳，可称之为optime。optime是备节点实现增量日志同步的关键，它保证了oplog是节点有序的，其由两部分组成
<ul>
<li>当前的系统时间，即UNIX时间至现在的秒数，32位</li>
<li>整数计时器，不同时间值会将计数器进行重置，32位</li>
</ul>
</li>
<li>optime属于BSON的Timestamp类型，这个类型一般在MongoDB内部使用</li>
</ul>
</li>
</ul>
</li>
<li>oplog 保证了节点级有序，那么备节点便可以通过轮询的方式进行拉取；这里会用到可持续追踪的游标（tailable&nbsp;cursor）技术
<ul>
<li><img src="/static/IT/MongoDB/MongoDB-%E5%A4%8D%E5%88%B6%E9%9B%86-5.png" alt="oplog">
<ul>
<li>每个备节点都分别维护了自己的一个offset，也就是从主节点拉取的最后一条日志的optime</li>
<li>在执行同步时就通过这个optime向主节点的oplog集合发起查询</li>
<li>为了避免不停地发起新的查询链接，在启动第一次查询后可以将cursor挂住（通过将cursor设置为tailable）</li>
<li>这样只要oplog中产生了新的记录，备节点就能使用同样的请求通道获得这些数据</li>
<li>tailable&nbsp;cursor只有在查询的集合为固定集合时才允许开启</li>
</ul>
</li>
</ul>
</li>
<li>oplog 集合的大小 <code>replication.oplogSizeMB</code>
<ul>
<li>默认值为 <code>oplogSizeMB&nbsp;=&nbsp;min(磁盘可用空间*5%，50GB)</code></li>
<li><code>db.oplog.rs.stats().maxSize</code> 查看oplog大小</li>
<li><code>replSetResizeOplog</code>命令，可以实现动态修改oplogSize而不需要重启服务器
<ul>
<li><code>db.adminCommand({replSetResizeOplog:&nbsp;1,&nbsp;size:&nbsp;60000})</code></li>
</ul>
</li>
</ul>
</li>
<li>oplog 幂等性：每一条oplog记录都描述了一次数据的原子性变更，对于oplog来说，必须保证是幂等性的</li>
<li>oplog 幂等性的代价
<ul>
<li>简单元素的操作，$inc&nbsp;转化为&nbsp;$set并没有什么影响，执行开销上也差不多</li>
<li>但当遇到数组元素操作时，情况就不一样了
<ul>
<li><code>$push</code>操作被转换为了<code>$set</code>操作（设置数组指定位置的元素为某个值），开销上也差不多</li>
<li>当向数组的头部添加元素时，oplog里的<code>$set</code>操作不再是设置数组某个位置的值（因为基本所有的元素位置都调整了），而是<code>$set</code>数组最终的结果，即整个数组的内容都要写入oplog</li>
<li>当push操作指定了<code>$slice</code>或者<code>$sort</code>参数时，oplog的记录方式也是一样的，会将整个数组的内容作为<code>$set</code>的参数</li>
<li><code>$pull</code>,&nbsp;<code>$addToSet</code>等更新操作符也是类似，更新数组后，oplog里会转换成<code>$set</code>数组的最终内容，才能保证幂等性</li>
</ul>
</li>
<li>大数组更新：oplog的写入被放大，导致同步追不上（致主备间网卡流量跑满）
<ul>
<li>当数组非常大时，对数组的一个小更新，可能就需要把整个数组的内容记录到oplog里</li>
<li>由于oplog的量太大，旧的内容很快被删除掉，最终导致Secondary追不上，转换为RECOVERING状态</li>
</ul>
</li>
<li>使用数组时，尽量注意
<ul>
<li>数组的元素个数不要太多，总的大小也不要太大</li>
<li>尽量避免对数组进行更新操作</li>
<li>如果一定要更新，尽量只在尾部插入元素，复杂的逻辑可以考虑在业务层面上来支持</li>
</ul>
</li>
</ul>
</li>
<li>oplog 复制延迟
<ul>
<li>由于oplog集合是有固定大小的，因此存放在里面的oplog随时可能会被新的记录冲掉</li>
<li>如果备节点的复制不够快，就无法跟上主节点的步伐，从而产生复制延迟（replication&nbsp;lag）问题</li>
<li>一旦备节点的延迟过大，则随时会发生复制断裂的风险
<ul>
<li>这意味着备节点的optime（最新一条同步记录）已经被主节点老化掉，于是备节点将无法继续进行数据同步</li>
</ul>
</li>
</ul>
</li>
<li>尽量避免复制延迟带来的风险
<ul>
<li>增加oplog的容量大小，并保持对复制窗口的监视</li>
<li>通过一些扩展手段降低主节点的写入速度</li>
<li>优化主备节点之间的网络</li>
<li>避免字段使用太大的数组（可能导致oplog膨胀）</li>
</ul>
</li>
<li>数据回滚
<ul>
<li>由于复制延迟是不可避免的，这意味着主备节点之间的数据无法保持绝对的同步</li>
<li>当复制集中的主节点宕机时，备节点会重新选举成为新的主节点
<ul>
<li>当旧的主节点重新加入时，必须回滚掉之前的一些“脏日志数据”，以保证数据集与新的主节点一致
<ul>
<li>主备复制集合的差距越大，发生大量数据回滚的风险就越高</li>
</ul>
</li>
</ul>
</li>
<li>对于写入的业务数据来说，如果已经被复制到了复制集的大多数节点，则可以避免被回滚的风险
<ul>
<li>应用上可以通过设定更高的写入级别（writeConcern：majority）来保证数据的持久性</li>
</ul>
</li>
<li>这些由旧主节点回滚的数据会被写到单独的rollback目录下，必要的情况下仍然可以恢复这些数据
<ul>
<li>当rollback发生时，MongoDB将把rollback的数据以BSON格式存放到dbpath路径下rollback文件夹中，BSON文件的命名格式：<code>&lt;database&gt;.&lt;collection&gt;.&lt;timestamp&gt;.bson</code></li>
<li><code>mongorestore&nbsp;‐‐host&nbsp;192.168.192:27018&nbsp;‐‐db&nbsp;test&nbsp;‐‐collection&nbsp;emp&nbsp;‐ufox&nbsp;‐pfox  ‐‐authenticationDatabase=admin&nbsp;rollback/emp_rollback.bson</code></li>
</ul>
</li>
</ul>
</li>
<li>同步源选择：MongoDB 是允许通过备节点进行复制的
<ul>
<li>在<code>settings.chainingAllowed</code>开启的情况下（默认是开启的），备节点自动选择一个最近的节点（ping命令时延最小）进行同步</li>
<li>默认情况下备节点并不一定会选择主节点进行同步，这个副作用就是会带来延迟的增加，关闭这个设置：
<ul>
<li><code>cfg&nbsp;=&nbsp;rs.config()</code></li>
<li><code>cfg.settings.chainingAllowed&nbsp;=&nbsp;false</code></li>
<li><code>rs.reconfig（cfg)</code></li>
</ul>
</li>
<li>使用<code>replSetSyncFrom</code>命令临时更改当前节点的同步源，比如在初始化同步时将同步源指向备节点来降低对主节点的影响
<ul>
<li><code>db.adminCommand(&nbsp;{&nbsp;replSetSyncFrom:&nbsp;"hostname:port"&nbsp;})</code></li>
</ul>
</li>
</ul>
</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">钱不寒</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jxch.github.io/2024/09/06/architect/mongodb/mongodb-fu-zhi-ji/">https://jxch.github.io/2024/09/06/architect/mongodb/mongodb-fu-zhi-ji/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">钱不寒</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MongoDB/">
                                    <span class="chip bg-color">MongoDB</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/09/06/architect/mongodb/mongodb-gao-ji-ji-qun-jia-gou/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="MongoDB-高级集群架构">
                        
                        <span class="card-title">MongoDB-高级集群架构</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-09-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/IT%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                    IT学习笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MongoDB/">
                        <span class="chip bg-color">MongoDB</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/09/06/architect/mongodb/mongodb-fen-pian-ji/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="MongoDB-分片集">
                        
                        <span class="card-title">MongoDB-分片集</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-09-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/IT%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                    IT学习笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MongoDB/">
                        <span class="chip bg-color">MongoDB</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2024</span>
            
            <a href="/about" target="_blank">钱不寒</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
                <span id="translate">|&nbsp;繁/简：</span><a id="translateLink" href="javascript:translatePage();">繁</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">545.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "11";
                        var startDate = "1";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/jxch" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:qianbuhan@proton.me" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100073531534496" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100073531534496" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/chengbushang" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/chengbushang" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2455930800" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2455930800" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/7558713016" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/7558713016" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/qianbuhan" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/qianbuhan" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    
        <!-- <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script> -->
        <script src='/libs/mermaid/mermaid.min.js'></script>
        <script>
          if (window.mermaid) {
            mermaid.initialize({theme: 'forest'});
          }
        </script>
    

    
        <script type="text/javascript" src="/js/tw_cn.js"></script>
        <script type="text/javascript">
          var defaultEncoding = 2; //网站编写字体是否繁体，1-繁体，2-简体
          var translateDelay = 0; //延迟时间,若不在前, 要设定延迟翻译时间, 如100表示100ms,默认为0
          var cookieDomain = "https://jxch.github.io"; //Cookie地址, 一定要设定, 通常为你的网址
          var msgToTraditionalChinese = "繁"; //此处可以更改为你想要显示的文字
          var msgToSimplifiedChinese = "简"; //同上，但两处均不建议更改
          var translateButtonId = "translateLink"; //默认互换id
          translateInitilization();
        </script>
    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
